# wecom-cleaner 实施计划（最终版）

## 1. 目标

将旧版脚本重构为可通过 npm/npx 一键使用的新程序，统一产品命名：

- 软件名：`wecom-cleaner`
- npm 全名称：`@mison/wecom-cleaner`

并确保支持：

- 多账号数据识别与选择
- 默认按年月清理旧聊天缓存
- 会话分析只读模式（明确能力限制）
- 删除后可恢复与冲突策略处理

## 2. 技术路线

1. 主体：Node.js 交互式 CLI/TUI 风格
- 原因：快速交付、跨平台、天然适配 npm/npx 分发。

2. Zig：核心能力预留
- 通过 `native/bin/<platform>-<arch>/wecom-cleaner-core` 桥接。
- 若不存在 Zig 核心，自动回退 Node 引擎。

3. 模块化目录
- `src/cli.js`：交互入口与菜单编排
- `src/scanner.js`：账号发现、月份发现、目录扫描
- `src/cleanup.js`：删除执行（移动到回收区）与索引记录
- `src/restore.js`：按批次恢复与冲突处理
- `src/analysis.js`：只读分析输出
- `src/config.js`：配置/别名持久化
- `src/native-bridge.js`：Zig 桥接与回退

## 3. 关键交互设计

1. 开始菜单
- 年月清理（默认）
- 会话分析（只读）
- 恢复已删除批次
- 交互配置

2. 年月清理模式
- 先选择账号（用户名 | 企业名 | 短ID 三列展示）
- 进入即弹出年月筛选配置（截止年月 or 手动勾选）
- 选择缓存类型与是否包含非月份目录
- 扫描预览（汇总+明细）
- 输入 `DELETE` 执行删除（移动到回收区）

3. 会话分析模式
- 只分析可见目录，不处理数据。
- 清晰提示企业微信私有库限制：无法自动按会话删除。

4. 恢复模式
- 按批次恢复。
- 冲突支持：覆盖 / 重命名 / 跳过，可应用到后续。

## 4. 数据安全与可追溯

1. 删除不直接 `rm`
- 统一移动到回收区（`~/.wecom-cleaner-state/recycle-bin`）。

2. 索引记录
- `index.jsonl` 记录每次删除和恢复动作。
- 包含批次、源路径、回收路径、账号、分类、体积等字段。

## 5. 多账号兼容方案

1. 自动识别 `Profiles` 下账号目录。
2. 账号信息多源提取：`io_data.json` + 用户别名文件。
3. 别名管理支持人工修正，保障列表可读性。

## 6. 运行与分发

1. 本地开发
- `npm install`
- `npm run dev`

2. 发布后运行
- `npx @mison/wecom-cleaner`

## 7. 后续迭代建议

1. 加入“扫描缓存”与“恢复”并发任务可视化进度条。
2. Zig 核心落地后，将目录遍历与体积计算迁移为高性能实现。
3. 增加 JSON 报告导出与审计视图。
